#!/usr/bin/env bash
set -euo pipefail

if [ $# -lt 1 ]; then
  echo "Uso: $0 URL_PLAYLIST [MAX_JOBS]" >&2
  echo "Esempio: $0 'https://www.youtube.com/playlist?list=XXXX' 4" >&2
  exit 1
fi

RAW_URL="$1"
MAX_JOBS="${2:-4}"

# Normalizza: se c'è list=XXXXX dentro la URL, costruiamo la URL playlist canonica
if [[ "$RAW_URL" == *"list="* ]]; then
  list_id="${RAW_URL##*list=}"   # prendi tutto dopo 'list='
  list_id="${list_id%%&*}"       # tronca ad eventuale '&'
  PLAYLIST_URL="https://www.youtube.com/playlist?list=${list_id}"
else
  PLAYLIST_URL="$RAW_URL"
fi

# Controlli di base
if ! command -v yt-dlp >/dev/null 2>&1; then
  echo "Errore: 'yt-dlp' non trovato nel PATH." >&2
  exit 1
fi

if ! command -v gyte-transcript >/dev/null 2>&1; then
  echo "Errore: 'gyte-transcript' non trovato nel PATH." >&2
  echo "Assicurati che 'gyte-transcript' sia nel PATH (vedi README)." >&2
  exit 1
fi

echo "URL playlist normalizzata: $PLAYLIST_URL"
echo "Recupero info playlist…"

# Prendo il titolo della playlist senza pipe a head, per evitare Broken pipe
PLAYLIST_TITLE="$(
  yt-dlp --ignore-config --flat-playlist --playlist-items 1 \
         --print '%(playlist_title)s' "$PLAYLIST_URL" 2>/dev/null || true
)"

if [ -z "$PLAYLIST_TITLE" ] || [ "$PLAYLIST_TITLE" = "NA" ]; then
  PLAYLIST_TITLE="$(
    yt-dlp --ignore-config --flat-playlist --playlist-items 1 \
           --print '%(playlist_id)s' "$PLAYLIST_URL" 2>/dev/null || true
  )"
fi

# Sanifica il nome per usarlo come directory
SAFE_NAME="$(printf '%s\n' "${PLAYLIST_TITLE:-playlist}" | tr ' /:\t' '_' | tr -s '_')"
