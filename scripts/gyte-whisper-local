#!/usr/bin/env bash
set -euo pipefail

# Uso:
#   gyte-whisper-local [--model MODEL] [--lang LANG] [--outdir DIR] FILE
#
# Esempi:
#   gyte-whisper-local lesson1.mp4
#   gyte-whisper-local --model small --lang en /path/to/video.mp4
#   gyte-whisper-local --outdir transcripts lesson1.mp4
#
# Env:
#   GYTE_WHISPER_MODEL   modello Whisper di default:
#                        - con whisper (openai-whisper CLI): tiny|base|small|medium|large
#                        - con whisper.cpp: path al file modello .bin (es. ./models/ggml-small.bin)
#                        default: "small"
#   GYTE_WHISPER_LANG    lingua di default (es. en, it, fr) oppure "auto"
#                        default: "auto"
#   GYTE_OUTDIR          directory di output di default (se non passi --outdir)
#   GYTE_STT_BIN         comando/binario STT (default: "whisper")
#
# Output:
#   Nella directory di output (default: cwd o GYTE_OUTDIR) vengono creati file tipo:
#     <basename>.txt   - testo puro
#     <basename>.srt   - sottotitoli SRT

usage() {
  cat >&2 <<'EOF'
Uso:
  gyte-whisper-local [--model MODEL] [--lang LANG] [--outdir DIR] FILE

Opzioni:
  --model MODEL     Modello Whisper (default: $GYTE_WHISPER_MODEL o "small")
  --lang LANG       Lingua (default: $GYTE_WHISPER_LANG o "auto")
  --language LANG   Alias di --lang
  --outdir DIR      Directory output (default: $GYTE_OUTDIR o cwd)
  -h, --help        Help

Env:
  GYTE_WHISPER_MODEL   modello (whisper CLI: tiny/base/small/medium/large; whisper.cpp: path .bin)
  GYTE_WHISPER_LANG    lingua (es. en/it/fr) o "auto"
  GYTE_OUTDIR          outdir di default
  GYTE_STT_BIN         binario STT (default: whisper)
EOF
}

MODEL="${GYTE_WHISPER_MODEL:-small}"
LANG="${GYTE_WHISPER_LANG:-auto}"
OUTDIR="${GYTE_OUTDIR:-}"
STT_BIN="${GYTE_STT_BIN:-whisper}"

# Parse args
while [ $# -gt 0 ]; do
  case "$1" in
    -h|--help)
      usage
      exit 0
      ;;
    --model)
      [ $# -ge 2 ] || { echo "Errore: --model richiede un argomento" >&2; exit 2; }
      MODEL="$2"
      shift 2
      ;;
    --model=*)
      MODEL="${1#--model=}"
      shift
      ;;
    --lang|--language)
      [ $# -ge 2 ] || { echo "Errore: $1 richiede un argomento" >&2; exit 2; }
      LANG="$2"
      shift 2
      ;;
    --lang=*|--language=*)
      LANG="${1#*=}"
      shift
      ;;
    --outdir)
      [ $# -ge 2 ] || { echo "Errore: --outdir richiede un argomento" >&2; exit 2; }
      OUTDIR="$2"
      shift 2
      ;;
    --outdir=*)
      OUTDIR="${1#--outdir=}"
      shift
      ;;
    --)
      shift
      break
      ;;
    -*)
      echo "Errore: opzione non riconosciuta: $1" >&2
      usage
      exit 2
      ;;
    *)
      break
      ;;
  esac
done

if [ $# -lt 1 ]; then
  echo "Errore: manca il FILE di input." >&2
  usage
  exit 1
fi

INPUT="$1"

if [ -z "$INPUT" ]; then
  echo "Errore: FILE di input vuoto." >&2
  exit 1
fi

if [[ "$INPUT" == -* ]]; then
  echo "Errore: il percorso del FILE non può iniziare con '-'." >&2
  exit 1
fi

if [ ! -f "$INPUT" ]; then
  echo "Errore: file non trovato: $INPUT" >&2
  exit 1
fi

# Outdir default = cwd se non specificato
if [ -z "$OUTDIR" ]; then
  OUTDIR="."
fi

if [[ "$OUTDIR" == -* ]]; then
  echo "Errore: OUTDIR non può iniziare con '-'." >&2
  exit 1
fi

# Verifica STT binario
if ! command -v "$STT_BIN" >/dev/null 2>&1; then
  echo "Errore: STT binario non trovato nel PATH: $STT_BIN" >&2
  echo "Suggerimento: esporta GYTE_STT_BIN con il comando corretto (es. whisper / whisper.cpp / altro)." >&2
  exit 1
fi

# Prepara directory di output
mkdir -p -- "$OUTDIR"

BASENAME="$(basename -- "$INPUT")"
BASENAME_NOEXT="${BASENAME%.*}"
OUT_TXT="$OUTDIR/$BASENAME_NOEXT.txt"
OUT_SRT="$OUTDIR/$BASENAME_NOEXT.srt"

# Detect backend (best-effort)
HELP_OUT="$("$STT_BIN" --help 2>&1 || true)"
BACKEND="unknown"
if echo "$HELP_OUT" | grep -q -- '--output_dir' && echo "$HELP_OUT" | grep -q -- '--output_format'; then
  BACKEND="whisper-cli"
elif echo "$HELP_OUT" | grep -q -- '-osrt' || echo "$HELP_OUT" | grep -q -- '-otxt'; then
  BACKEND="whisper-cpp"
fi

echo ">> gyte-whisper-local"
echo "   input   : $INPUT"
echo "   outdir  : $OUTDIR"
echo "   model   : $MODEL"
echo "   lang    : $LANG"
echo "   stt_bin : $STT_BIN"
echo "   backend : $BACKEND"
echo

case "$BACKEND" in
  whisper-cli)
    # openai-whisper CLI:
    # whisper input.mp4 --model small --output_dir OUT --output_format "txt,srt" [--language en]
    whisper_args=("$INPUT" --model "$MODEL" --output_dir "$OUTDIR" --output_format "txt,srt")
    if [ -n "$LANG" ] && [ "$LANG" != "auto" ]; then
      whisper_args+=( --language "$LANG" )
    fi
    "$STT_BIN" "${whisper_args[@]}"
    ;;
  whisper-cpp)
    # whisper.cpp:
    # richiede modello come path .bin: -m ./models/ggml-small.bin
    # output: -of OUTDIR/base  + -otxt -osrt
    if [[ "$MODEL" != *.* && "$MODEL" != */* ]]; then
      echo "Errore: sembra whisper.cpp, ma GYTE_WHISPER_MODEL/--model non è un path (.bin)." >&2
      echo "Imposta un path modello, es: export GYTE_WHISPER_MODEL=./models/ggml-small.bin" >&2
      exit 1
    fi
    cpp_args=( -m "$MODEL" -f "$INPUT" -of "$OUTDIR/$BASENAME_NOEXT" -otxt -osrt )
    if [ -n "$LANG" ] && [ "$LANG" != "auto" ]; then
      cpp_args+=( -l "$LANG" )
    else
      cpp_args+=( -l auto )
    fi
    "$STT_BIN" "${cpp_args[@]}"
    ;;
  *)
    echo "Errore: backend STT non riconosciuto. Non so che flag usare per '$STT_BIN'." >&2
    echo "Suggerimento: usa openai-whisper CLI (comando 'whisper') oppure whisper.cpp, e imposta GYTE_STT_BIN di conseguenza." >&2
    exit 1
    ;;
esac

echo
echo ">> Transcription completata."
echo "   TXT: $OUT_TXT"
echo "   SRT: $OUT_SRT"
echo "   Prossimo step tipico:"
echo "     gyte-reflow-text --ai-friendly \"$OUT_TXT\" > \"$OUTDIR/$BASENAME_NOEXT.ai.txt\""
