#!/usr/bin/env bash
set -euo pipefail

# ----------------------------
# gyte-audio
# Wrapper hardenizzato per yt-dlp: estrazione audio + conversione (ffmpeg)
#
# Commit 9:
#   - In modalità --json, il comando diventa automaticamente quiet
#     (stdout/stderr puliti per piping), senza richiedere --quiet esplicito.
# ----------------------------

die()  { echo "Errore: $*" >&2; exit 1; }
warn() { echo "ATTENZIONE: $*" >&2; }
info() { [ "${QUIET:-0}" -eq 1 ] && return 0; echo ">> $*" >&2; }
vlog() { [ "${VERBOSE:-0}" -eq 1 ] || return 0; info "$*"; }

usage() {
  cat >&2 <<'EOF'
Uso:
  gyte-audio [OPZIONI] URL_YOUTUBE [ALTRI_ARG_YT_DLP...]

Doc estesa:
  docs/gyte-audio.md

Esempi rapidi:
  gyte-audio --preset voice --out ./audio URL
  gyte-audio --no-warnings --print filename --out ./audio URL
  gyte-audio --dry-run --json --strict --preset hq URL | jq -r '.yt_dlp_cmd_string'

Opzioni GYTE:
  -h, --help
  --preset NAME              voice|hq|lossless
  --format FMT
  --quality Q
  --playlist / --no-playlist
  --out DIR
  --dry-run
  --json                     (auto-quiet)
  --print FIELD              filename|title|id|webpage_url
  --print-template TEMPLATE  template yt-dlp libero
  --no-warnings
  --strict
  --quiet
  --verbose

Note:
  - --json implica output pulito (quiet automatico).
  - --print e --print-template sono mutuamente esclusivi.
EOF
}

require_deps() {
  # In --dry-run non verifichiamo dipendenze runtime: deve restare deterministico e silenzioso.
  if [ "${DRY_RUN:-0}" -ne 1 ]; then
    command -v yt-dlp >/dev/null 2>&1 || die "'yt-dlp' non trovato nel PATH."
    if ! command -v ffmpeg >/dev/null 2>&1; then
      warn "'ffmpeg' non trovato nel PATH. L'estrazione audio potrebbe fallire."
    fi
  fi
}

normalize_quality() {
  local q="$1"
  case "$q" in
    *k) q="${q%k}K" ;;
  esac
  printf '%s' "$q"
}

print_command_quoted() {
  local -a cmd=("$@")
  local i
  for i in "${cmd[@]}"; do printf '%q ' "$i"; done
  printf '\n'
}

json_escape() {
  local s="$1"
  s=${s//\\/\\\\}
  s=${s//\"/\\\"}
  s=${s//$'\n'/\\n}
  s=${s//$'\r'/\\r}
  s=${s//$'\t'/\\t}
  printf '%s' "$s"
}

json_bool() { [ "$1" -eq 1 ] && printf 'true' || printf 'false'; }

json_array_from_args() {
  local first=1
  printf '['
  local arg esc
  for arg in "$@"; do
    esc="$(json_escape "$arg")"
    if [ $first -eq 1 ]; then
      first=0; printf '"%s"' "$esc"
    else
      printf ',"%s"' "$esc"
    fi
  done
  printf ']'
}

emit_json() {
  local cmd_str
  cmd_str="$(json_escape "$(print_command_quoted "${yt_cmd[@]}")")"

  printf '{'
  printf '"url":"%s",' "$(json_escape "$URL")"
  printf '"preset":"%s",' "$(json_escape "${PRESET-}")"
  printf '"audio_format":"%s",' "$(json_escape "$EFFECTIVE_AUDIO_FORMAT")"
  printf '"audio_quality":"%s",' "$(json_escape "$EFFECTIVE_AUDIO_QUALITY")"
  printf '"playlist":%s,' "$( [ "$PLAYLIST_MODE" = "yes" ] && echo true || echo false )"
  printf '"strict":%s,' "$(json_bool "$STRICT")"
  printf '"out_dir":"%s",' "$(json_escape "${OUT_DIR-}")"
  printf '"print_field":"%s",' "$(json_escape "${PRINT_FIELD-}")"
  printf '"print_template":"%s",' "$(json_escape "${PRINT_TEMPLATE-}")"
  printf '"no_warnings":%s,' "$(json_bool "$NO_WARNINGS")"
  printf '"safe_args_count":%s,' "${#safe_args[@]}"
  printf '"yt_dlp_cmd_string":"%s",' "$cmd_str"
  printf '"yt_dlp_cmd_args":'
  json_array_from_args "${yt_cmd[@]}"
  printf '}\n'
}

print_field_to_yt_dlp() {
  case "$1" in
    filename|title|id|webpage_url) printf '%s' "$1" ;;
    *) die "--print FIELD non valido" ;;
  esac
}

preset_to_settings() {
  case "$1" in
    voice)    printf 'mp3|96K' ;;
    hq)       printf 'mp3|320K' ;;
    lossless) printf 'flac|0' ;;
    *) die "--preset non valido" ;;
  esac
}

# ----------------------------
# Parse args
# ----------------------------
URL=""
PRESET=""
CLI_FORMAT=""
CLI_QUALITY=""
PLAYLIST_MODE="no"
DRY_RUN=0
STRICT=0
QUIET=0
VERBOSE=0
JSON=0
OUT_DIR=""
PRINT_FIELD=""
PRINT_TEMPLATE=""
NO_WARNINGS=0

extra_args=()
safe_args=()

parse_args() {
  local arg
  while (("$#")); do
    arg="$1"; shift
    if [ -z "$URL" ]; then
      case "$arg" in
        -h|--help) usage; exit 0 ;;
        --preset) PRESET="$1"; shift ;;
        --preset=*) PRESET="${arg#--preset=}" ;;
        --format) CLI_FORMAT="$1"; shift ;;
        --format=*) CLI_FORMAT="${arg#--format=}" ;;
        --quality) CLI_QUALITY="$1"; shift ;;
        --quality=*) CLI_QUALITY="${arg#--quality=}" ;;
        --playlist) PLAYLIST_MODE="yes" ;;
        --no-playlist) PLAYLIST_MODE="no" ;;
        --out) OUT_DIR="$1"; shift ;;
        --out=*) OUT_DIR="${arg#--out=}" ;;
        --dry-run) DRY_RUN=1 ;;
        --json) JSON=1 ;;
        --print) PRINT_FIELD="$1"; shift ;;
        --print=*) PRINT_FIELD="${arg#--print=}" ;;
        --print-template) PRINT_TEMPLATE="$1"; shift ;;
        --print-template=*) PRINT_TEMPLATE="${arg#--print-template=}" ;;
        --no-warnings) NO_WARNINGS=1 ;;
        --strict) STRICT=1 ;;
        --quiet) QUIET=1 ;;
        --verbose) VERBOSE=1 ;;
        --) URL="$1"; shift; break ;;
        -*)
          echo "Opzione sconosciuta prima dell'URL: $arg" >&2
          exit 2
          ;;
        *) URL="$arg" ;;
      esac
    else
      extra_args+=("$arg")
    fi
  done
  while (("$#")); do extra_args+=("$1"); shift; done
}

filter_safe_args() {
  safe_args=()
  local arg
  for arg in "$@"; do
    case "$arg" in
      --exec*|--run-postprocessor*|--postprocessor-args*)
        die "Opzione yt-dlp non consentita: $arg" ;;
      --config-location*)
        [ "$STRICT" -eq 1 ] && die "Opzione vietata in --strict: $arg"
        safe_args+=("$arg") ;;
      *) safe_args+=("$arg") ;;
    esac
  done
}

parse_args "$@"

[ -n "$URL" ] || { usage; exit 2; }

# Commit 9: --json ⇒ quiet automatico
if [ "$JSON" -eq 1 ]; then
  QUIET=1
fi

if [ "$JSON" -eq 1 ] && [ "$DRY_RUN" -ne 1 ]; then
  die "--json è consentito solo con --dry-run"
fi

if [ -n "$PRINT_FIELD" ] && [ -n "$PRINT_TEMPLATE" ]; then
  die "--print e --print-template sono mutuamente esclusivi"
fi

[ "$QUIET" -eq 1 ] && VERBOSE=0

require_deps

# Preset
PRESET_FORMAT=""
PRESET_QUALITY=""
if [ -n "$PRESET" ]; then
  pair="$(preset_to_settings "$PRESET")"
  PRESET_FORMAT="${pair%%|*}"
  PRESET_QUALITY="${pair#*|}"
fi

# Compute format / quality
EFFECTIVE_AUDIO_FORMAT="${CLI_FORMAT:-${PRESET_FORMAT:-${GYTE_AUDIO_FORMAT:-${AUDIO_FORMAT:-mp3}}}}"
EFFECTIVE_AUDIO_QUALITY="${CLI_QUALITY:-${PRESET_QUALITY:-${GYTE_AUDIO_QUALITY:-${AUDIO_QUALITY:-192K}}}}"
EFFECTIVE_AUDIO_QUALITY="$(normalize_quality "$EFFECTIVE_AUDIO_QUALITY")"

PLAYLIST_FLAG="--no-playlist"
[ "$PLAYLIST_MODE" = "yes" ] && PLAYLIST_FLAG="--yes-playlist"

filter_safe_args "${extra_args[@]}"

output_tpl="%(uploader)s - %(title).80s [%(id)s].%(ext)s"
[ -n "$OUT_DIR" ] && output_tpl="${OUT_DIR%/}/$output_tpl"

yt_cmd=( yt-dlp )
[ "$STRICT" -eq 1 ] && yt_cmd+=( --ignore-config )
[ "$NO_WARNINGS" -eq 1 ] && yt_cmd+=( --no-warnings )
yt_cmd+=( "$PLAYLIST_FLAG" )

if [ -n "$PRINT_FIELD" ] || [ -n "$PRINT_TEMPLATE" ]; then
  yt_cmd+=( -o "$output_tpl" --no-download )
  if [ -n "$PRINT_FIELD" ]; then
    yt_cmd+=( --print "$(print_field_to_yt_dlp "$PRINT_FIELD")" )
  else
    yt_cmd+=( --print "$PRINT_TEMPLATE" )
  fi
  yt_cmd+=("${safe_args[@]}" "$URL")
  if [ "$DRY_RUN" -eq 1 ]; then
    [ "$JSON" -eq 1 ] && emit_json || print_command_quoted "${yt_cmd[@]}"
    exit 0
  fi
  exec "${yt_cmd[@]}"
fi

yt_cmd+=(
  -f bestaudio/best
  -x
  --audio-format "$EFFECTIVE_AUDIO_FORMAT"
  --audio-quality "$EFFECTIVE_AUDIO_QUALITY"
  --no-embed-subs
  -o "$output_tpl"
)
yt_cmd+=("${safe_args[@]}" "$URL")

if [ "$DRY_RUN" -eq 1 ]; then
  [ "$JSON" -eq 1 ] && emit_json || print_command_quoted "${yt_cmd[@]}"
  exit 0
fi

[ -n "$OUT_DIR" ] && mkdir -p -- "$OUT_DIR"
exec "${yt_cmd[@]}"